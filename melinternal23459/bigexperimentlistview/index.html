<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Experiment Viewer</title>
  <script src="jquery.js"></script>
    <link rel="icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <!-- Bootstrap core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/paper/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="//getbootstrap.com/examples/offcanvas/offcanvas.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body style="padding-left: 20px; padding-top: 0px; margin-top: 0px;">
<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Experiment Viewer</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li id="navCategories" class="navoption active" onclick="onCategoriesClick(); return false;"><a href="#">Categories</a></li>
        <li id="navCategoriesByPop" class="navoption" onclick="onCategoriesByPopClick(); return false;"><a href="#">Categories!</a></li>
        <li id="navClasses" class="navoption"><a href="#" onclick="onClassesClick(); return false;">Classes</a></li>
        <li id="navAllByCoolness" class="navoption"><a href="#" onclick="onAllByCoolnessClick(); return false;">Coolness</a></li>
        <li id="navAllBySafety" class="navoption"><a href="#" onclick="onAllBySafetyClick(); return false;">Safety</a></li>
        <li id="navAllAwarness" class="navoption"><a href="#" onclick="onAllClick(); return false;">All</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="cards.html" target="_blank">Cards</a></li>
        <li><a href="https://docs.google.com/a/melscience.com/spreadsheets/d/1Ef0QETC_X2G-kADrHpkiYIeMEQl5gnUHy_pnZKadJ1Q/edit#gid=0">Edit</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
 
<p>
<div id="viewtype" class="btn-group pull-left" data-toggle="buttons" style="dysplay: inline-block;">
  <label class="btn btn-primary">
    <input type="radio" value="list" name="options" id="optionlist">List
  </label>
  <label class="btn btn-primary">
    <input type="radio" value="card" name="options" id="optioncards">Cards
  </label>
  <label class="btn btn-primary active">
    <input type="radio" value="table" name="options" id="optioncards" checked>Table
  </label>
</div>
<a class="btn btn-primary" href="#" id="accShow" style="margin-left: 20px;">Show All</a>

<script>
var currentViewType = "table";
var currentGroupType = "categories";

$('#viewtype input').change(function() {
  $(this).addClass('active').siblings().removeClass('active');
  currentViewType = $(this).val();
  if (currentViewType=="list") {
    $("#accordion").css("width", "600px");
  } else {
    $("#accordion").css("width", "100%");
  }
  updateTheList();
});

$('#accShow').on('click', function() {
    if($(this).text() == 'Show All') {
        $('.collapse:not(.in)').each(function (index) {
            $(this).collapse("toggle");
        });
        $(this).text('Hide All');
    } else {
        $(this).text('Show All');
        $('.collapse.in').each(function (index) {
            $(this).collapse("toggle");
        });
    }
    return false;
});
</script>
</p>

<div id="container">

<div class="panel-group" id="accordion" style="width: 100%">
  <div class="panel panel-default" id="groupcontainer">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" id="groupname">
          Collapsible Group Item #1
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse">
      <div class="panel-body">
  <div id="samplecard" style="border:1px solid black; margin: 10px; width: 302px; height: 284px; display: inline-block; background-color: gray; -webkit-print-color-adjust: exact; position: relative;">
    <div id="title" style="color: white; width: 282px; margin-top: 2px; font-size: 15px; font-family: Arial; text-align: center; position: absolute; top: 3px; left: 5px;">Title</div>
    <div id="chemicalequation" style="color: white; width: 175px; font-size: 9px; font-family: Arial; position: absolute; top: 45px; left: 7px; ">chemicalequation</div>
    <div id="category" style="color: white; width: 100px; font-size: 9px; font-family: Arial; position: absolute; top: 45px; left: 185px; text-align: right; ">category</div>
    <div id="descriptivename" style="color: white; width: 282px; font-size: 9px; font-family: Arial; position: absolute; top: 85px; left: 5px; overflow:hidden; height: 15px; text-overflow: ellipsis;">descriptivename</div>
    <img id="thumbnail" src="" width="240" height="180" style="position: absolute; top: 104px; left: 0px">
    <table width="62" height="180" style="position: absolute; top: 104px; left: 240px; border: 2px solid black; border-collapse: collapse;">
      <tr><td style="height: 50%; border: 2px solid black; text-align: center; font-size: 15px; font-family: Arial; background-color: black; color: white; height: 41px; padding: 0px;"><div id="totalscore" style="font-size: 30px; padding: 0px; margin: -5px;">0</div></td></tr>
      <tr><td style="border: 2px solid black; text-align: center; font-size: 15px; font-family: Arial; background-color: white; color: black; height: 41px; padding: 0px;"><div id="safety" style="font-size: 28px; padding: 0px; margin: -5px;">0</div></td></tr>
      <tr><td style="border: 2px solid black; text-align: center; font-size: 15px; font-family: Arial; background-color: white; color: black; height: 41px; padding: 0px;"><div id="coolness" style="font-size: 28px; padding: 0px; margin: -5px;">0</div></td></tr>
    </table>
  </div>
        <li id="samplelist" style="overflow:hidden; height: 30px; text-overflow: ellipsis;">
          <span id="title" style="overflow:hidden; height: 20px; text-overflow: ellipsis;" title="">Title</span> <span class="badge pull-right" id="totalscore"></span>
        </li>
        <table id="tablecontainer" style="border-collapse: collapse; border: 1px solid gray">
         <tbody>
         <tr id="headerrow" style="height: 50px; border: 1px solid gray">
          <td style="width: 40px; border: 1px solid gray; padding-right: 4px" align="right">#</td>
          <td style="width: 480px; border: 1px solid gray; padding-left: 7px">Title</td>
          <td style="height: 50px; width: 480px; border: 1px solid gray; padding-left: 7px; overflow:hidden; text-overflow: ellipsis;">Description</td>
          <td style="height: 50px; width: 300px; border: 1px solid gray; padding-left: 7px;">Equation</td>
          <td style="height: 50px; width: 150px; border: 1px solid gray; padding-left: 7px;">Category</td>
          <td style="width: 30px; border: 1px solid gray; padding-left: 3px">Saf</td>
          <td style="width: 30px; border: 1px solid gray; padding-left: 3px">Coo</td>
         </tr>
         <tr id="sampletable" style="height: 50px; border: 1px solid gray">
          <td id="expid" style="width: 40px; border: 1px solid gray; padding-right: 4px" align="right">ID</td>
          <td id="title" style="width: 480px; border: 1px solid gray; padding-left: 7px">TITLE</td>
          <td id="descriptivename" style="height: 50px; width: 480px; border: 1px solid gray; padding-left: 7px; overflow:hidden; text-overflow: ellipsis;">descriptivename</td>
          <td id="chemicalequation" style="height: 50px; width: 300px; border: 1px solid gray; padding-left: 7px;">chemicalequation</td>
          <td id="category" style="height: 50px; width: 150px; border: 1px solid gray; padding-left: 7px;">category</td>
          <td id="safety" style="width: 30px; border: 1px solid gray; padding-left: 3px">SA</td>
          <td id="coolness" style="width: 30px; border: 1px solid gray; padding-left: 3px">CO</td>
         </tr>
         </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="experimentDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="width: 700px;">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="experimentDialogTitle">Modal title</h4>
      </div>
      <div class="modal-body">
        <p id="experimentDialogDescriptiveName"></p>
        <p id="experimentDialogReaction"></p>
        <p>Category: <span id="experimentDialogCategory"></span></p>
        <p>Class: <span id="experimentDialogClass"></span></p>
        <p>Reagents:
        <ul id="experimentDialogReagents" style="margin-top: 0px; padding-top: 0px;">
        </ul>
        </p>
        <div style="width: 700px; height: 1px"></div>
        <iframe id="experimentDialogVideo" width="640" height="480" src="http://www.youtube.com/embed/B_zD3NxSsD8?rel=0" frameborder="0" allowfullscreen></iframe>
      </div>
      <div class="modal-footer">
        <textarea style="width: 600px; height: 50px; border: 1px solid #E0E0E0; font-size: 10px;" id="experimentDialogYAML">aaa</textarea>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</div>


<script type="text/javascript">
var currentGroupContainer = "";
var groupIndex = 0;

function ellipseString(s, n) {
  if (s.length>n) {
    return s.substring(0, n-3) + "...";
  } else {
    return s;rl
  }
}

function addGroup(name, count) {
    groupIndex = groupIndex + 1;
    var cattegoryElement = $("#groupcontainer").clone();
    $(cattegoryElement).attr("id", "groupcontainer" + groupIndex);

    var a = cattegoryElement.find("#groupname");
    a.html(name + " [" + count + "]");
    a.attr("href", "#collapse" + groupIndex);

    var hiddenDiv = cattegoryElement.find("#collapseOne");
    hiddenDiv.attr("id", "collapse" + groupIndex);

    if (getViewType()=="table") {
      currentGroupContainer = cattegoryElement.find("#tablecontainer > tbody:last");
    } else {
      currentGroupContainer = cattegoryElement.find(".panel-body");
      $(cattegoryElement).find("#headerrow").remove();
    }
    $(cattegoryElement).find("#samplecard").remove();
    $(cattegoryElement).find("#samplelist").remove();
    $(cattegoryElement).find("#sampletable").remove();
    $("#accordion").append(cattegoryElement); 
}

function generateExperimentYAML(id) {
  var s = "";
  s = s + "---\n";
  s = s + "id: ?\n";
  s = s + "type: experiment\n";
  s = s + "layout: experiment\n";
  s = s + "title_name: " + gss(id, "title") + "\n";
  s = s + "descriptive_name: " + gss(id, "descriptivename") + "\n";
  s = s + "scientific_name: ?\n";
  s = s + "category: " + gss(id, "category") + "\n";
  s = s + "class: " + gss(id, "class") + "\n";
  s = s + "week: ?\n";
  s = s + "reaction_formulas:\n"
  s = s + "  - ?\n";
  s = s + "reagents:\n"
  s = s + "  - ?\n";
  s = s + "  - ?\n";
  s = s + "youtube_videos:\n";
  s = s + "  - link: " + gss(id, "youtube") + "\n";
  s = s + "  - link: ?\n";
  s = s + "youtube_video_for_thumbnail: ?\n";
  s = s + "links:\n";
  s = s + "  - link: " + gss(id, "url") + "\n";
  s = s + "    title: ?\n";
  s = s + "    language: en\n";
  s = s + "  - link: ?\n";
  s = s + "    title: ?\n";
  s = s + "    language: en\n";
  s = s + "step_by_step: |\n";
  s = s + "  ???\n";
  s = s + "safety_description: |\n";
  s = s + "  ??Wear eye protection goggles.??\n";
  s = s + "science_background: |\n";
  s = s + "  ???\n";
  s = s + "safety: " + gss(id, "safety")+ "\n";
  s = s + "coolness: " + gss(id, "coolness")+ "\n";
  s = s + "fire: " + gss(id, "fire")+ "\n";
  s = s + "heating_with_fire: ?\n";
  s = s + "explosion: " + gss(id, "explosion")+ "\n";
  s = s + "poisoned_gas: " + gss(id, "poisonedgas")+ "\n";
  s = s + "heating_with_fire: ?\n";
  s = s + "organic: " + gss(id, "organic")+ "\n";
  s = s + "electricity: " + gss(id, "electricity")+ "\n";
  s = s + "solution: " + gss(id, "solution")+ "\n";
  s = s + "oxydation_reduction: ?\n";
  s = s + "color_change: ?\n";
  s = s + "precipitate: ?\n";
  s = s + "gassing: ?\n";
  s = s + "catalyst: ?\n";
  s = s + "phases_gas: ?\n";
  s = s + "phases_liquide: ?\n";
  s = s + "phases_solid: ?\n";
  s = s + "---\n";
  
/*

* result_reagents (list)
Если этот опыт - это получение какого-то вещества, особенно того, для которого потом есть много опытов как его использовать, то мы указываем такое вещество тут. Если их несколько (хотя такого почти не бывает), то все. Не притягиваем за уши. Если в опыте что-то образуется, но в таких количествах или в такой не удобной форме, что это фиг используешь дальше, то ничего не указываем.

*/

  return s;
}

function showExperimentDialog(id) {
  $("#experimentDialogTitle").html("#" + id + " " + gss(id, "title"));
  $("#experimentDialogDescriptiveName").html(gss(id, "descriptivename"));
  $("#experimentDialogCategory").html(gss(id, "category"));
  $("#experimentDialogClass").html(gss(id, "class"));
  $("#experimentDialogYAML").html(generateExperimentYAML(id));

  var video = gss(id, "youtube");
  var pos = video.indexOf("?v=");
  if (pos!=-1) {
    var youtubeId = video.substring(pos+3);
    var videoURL = "http://www.youtube.com/embed/" + youtubeId + "?rel=0";
    $("#experimentDialogVideo").attr("src", videoURL);
    $("#experimentDialogVideo").show();
  } else {
    $("#experimentDialogVideo").hide();
  }

  $("#experimentDialog").modal({});
}

function getViewType() {
  return currentViewType;
}

function getSampleId() {
  return "sample" + getViewType();
}

function addExperiment(id, title, descriptivename, category, experimentclass, video, videoforthumbnail, safety, coolness) {
  var copy = $("#" + getSampleId()).clone();
  copy.find("#title").html(ellipseString(title, 90));
  copy.find("#descriptivename").html(descriptivename);
  var pos = video.indexOf("?v=");
  if (pos!=-1) {
    var youtubeId = video.substring(pos+3);
    copy.find("#thumbnail").attr("src","http://img.youtube.com/vi/" + youtubeId + "/0.jpg");
  } else {
    var pos = videoforthumbnail.indexOf("?v=");
    if (pos!=-1) {
      var youtubeId = videoforthumbnail.substring(pos+3);
      copy.find("#thumbnail").attr("src","http://img.youtube.com/vi/" + youtubeId + "/0.jpg");
    }
  }
  copy.find("#expid").html(id);
  copy.find("#safety").html(safety);
  copy.find("#coolness").html(coolness);
  copy.find("#category").html("[" + category + "]");
  copy.find("#experimentclass").html(experimentclass);
  $(copy).attr("id", "experiment" + id);
  copy.attr("onclick", "showExperimentDialog(" + id + "); return false;");

  if (getViewType()=="card") {
    if (experimentclass.indexOf("classics")!=-1) {$(copy).css('background-color', '#5cb85c');}
    if (experimentclass.indexOf("crystals")!=-1) {$(copy).css('background-color', '#428bca');}
    if (experimentclass.indexOf("fire")!=-1) {$(copy).css('background-color', '#d9534f');}
    if (experimentclass.indexOf("house")!=-1) {$(copy).css('background-color', '#f0ad4e');}
    if (experimentclass.indexOf("metaloelectro")!=-1) {$(copy).css('background-color', 'rgb(127, 127, 127)');}
  }

  $(currentGroupContainer).append(copy); 
}

function coolnessComparator(a, b) {
  return b["gsx$coolness"]["$t"] - a["gsx$coolness"]["$t"];
}

var experiments = [];

function gss(row, name) {
  return experiments[row]["gsx$" + name]["$t"]
}


function parseJson(json) {
  for (var i=0; i<json.feed.entry.length; i++) {
    experiments[i] = json.feed.entry[i];
  }
  experiments.sort(coolnessComparator);
  console.log(experiments);
}

var categories = {};
var sortedCategories = [];
var sortedCategoriesByPop = [];

function categorySortFunction(a, b) {
  var x = categories[a];
  var y = categories[b];

  return x < y ? 1 : (x > y ? -1 : 0);  
}


function buildCategoryList() {
  for (var i=0; i<experiments.length; i++) {
    var experimentcategories = gss(i, "category").split(",");
    for (var j=0; j<experimentcategories.length; j++) {
      var c = experimentcategories[j].trim();
      if (c != "") {
        if (categories.hasOwnProperty(c)) {
          categories[c] = categories[c] + 1;
        } else {
          categories[c] = 1;
        }
      } 
    }
  }
  for (var c in categories) {
    if (categories.hasOwnProperty(c)) {
      sortedCategories.push(c);
      sortedCategoriesByPop.push(c);
    }
  }
  sortedCategories.sort();
  sortedCategoriesByPop.sort(categorySortFunction);
  console.log("Categories");
  console.log(sortedCategories);
  console.log(sortedCategoriesByPop);
}

var classes = {};
var sortedClasses = [];

function buildClassList() {
  for (var i=0; i<experiments.length; i++) {
      var c = gss(i, "class")
      if (c != "") {
        if (classes.hasOwnProperty(c)) {
          classes[c] = classes[c] + 1;
        } else {
          classes[c] = 1;
        }
      } 
  }
  for (var c in classes) {
    if (classes.hasOwnProperty(c)) {
      sortedClasses.push(c);
    }
  }
  sortedClasses.sort();
  console.log("Classes");
  console.log(sortedClasses);
}

var reagents = {};
var sortedReagents = [];
var sortedReagentsByPop = [];

function reagentSortFunction(a, b) {
  var x = reagents[a];
  var y = reagents[b];

  return x < y ? 1 : (x > y ? -1 : 0);  
}

var allByCoolness = {};
var allBySafety = {};
var all = {};
var sortedMarks = ["3", "2", "1", "0"];
var sortedAll = ["All Experiments"];

function buildFullList() {
  for (var i=0; i<experiments.length; i++) {
    var c = "" + Math.floor(parseFloat(gss(i, "coolness")));
    if (c != "") {
      if (allByCoolness.hasOwnProperty(c)) {
        allByCoolness[c] = allByCoolness[c] + 1;
      } else {
        allByCoolness[c] = 1;
      }
    }

    var c = "" + Math.floor(parseFloat(gss(i, "safety")));
    if (c != "") {
      if (allBySafety.hasOwnProperty(c)) {
        allBySafety[c] = allBySafety[c] + 1;
      } else {
        allBySafety[c] = 1;
      }
    }
  }

  all["All Experiments"] = experiments.length;
}


function changeList(groupArr, groupHash, checkFunc) {
  for (var j=0; j<groupArr.length; j++) {
      var groupName = groupArr[j];
      addGroup(groupName, groupHash[groupName]);
      for (var i=0; i<experiments.length; i++) {
        if (checkFunc(i, groupName)) {
          addExperiment(i, 
            gss(i, "title"),
            gss(i, "descriptivename"),
            gss(i, "category"),
            gss(i, "class"),
            gss(i, "youtube"),
            gss(i, "youtube"),
            gss(i, "safety"),
            gss(i, "coolness")
          );
        }
      }
   }
}

function importGSS(json) {
  console.log('EEE finished');
  console.log(json);
  parseJson(json);
  buildCategoryList();
  buildClassList();
  buildFullList();

  changeList(sortedCategories, categories, function (i, name) {
    return gss(i, "category").indexOf(name) != -1;
  });

  $("#groupcontainer").hide();
}

function cleanTheList() {
  $("#groupcontainer").show();
  $("#accordion").children().filter(':not(#groupcontainer)').hide();
}

function updateTheList() {
  cleanTheList();

  if (currentGroupType=="classes") {
    changeList(sortedClasses, classes, function (i, name) {
      return gss(i, "class") == name;
    });
  }

  if (currentGroupType=="categories") {
    changeList(sortedCategories, categories, function (i, name) {
      return gss(i, "category").indexOf(name) != -1;
    });
  }

  if (currentGroupType=="categoriesbypop") {
    changeList(sortedCategoriesByPop, categories, function (i, name) {
      return gss(i, "category").indexOf(name) != -1;
    });
  }

  if (currentGroupType=="reagents") {
    changeList(sortedReagents, reagents, function (i, name) {
      return gss(i, "reagent1") == name || gss(i, "reagent2") == name || gss(i, "reagent3") == name || gss(i, "reagent4") == name ;
    });
  }

  if (currentGroupType=="reagentsbypop") {
    changeList(sortedReagentsByPop, reagents, function (i, name) {
      return gss(i, "reagent1") == name || gss(i, "reagent2") == name || gss(i, "reagent3") == name || gss(i, "reagent4") == name ;
    });
  }

  if (currentGroupType=="all") {
    changeList(sortedAll, all, function (i, name) {
      return true;
    });
  }

  if (currentGroupType=="allbycoolness") {
    changeList(sortedMarks, allByCoolness, function (i, mark) {
      return Math.floor(parseFloat(gss(i, "coolness3-cool0-boring")))==mark;
    });
  }

  if (currentGroupType=="allbysafety") {
    changeList(sortedMarks, allBySafety, function (i, mark) {
      return Math.floor(parseFloat(gss(i, "safety3-safe0-dangerous")))==mark;
    });
  }

  $("#groupcontainer").hide();
}

function onClassesClick() {
  currentGroupType = "classes";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navClasses").addClass("active");
}

function onCategoriesClick() {
  currentGroupType = "categories";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navCategories").addClass("active");
}

function onCategoriesByPopClick() {
  currentGroupType = "categoriesbypop";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navCategoriesByPop").addClass("active");
}

function onReagentsClick() {
  currentGroupType = "reagents";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navReagents").addClass("active");
}

function onReagentsByPopClick() {
  currentGroupType = "reagentsbypop";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navReagentsByPop").addClass("active");
}

function onAllByCoolnessClick() {
  currentGroupType = "allbycoolness";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navAllByCoolness").addClass("active");
}

function onAllBySafetyClick() {
  currentGroupType = "allbysafety";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navAllBySafety").addClass("active");
}

function onAllClick() {
  currentGroupType = "all";
  $(".navoption").removeClass("active");
  updateTheList();
  $("#navAll").addClass("active");
}

</script>

<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<script src="https://spreadsheets.google.com/feeds/list/1Ef0QETC_X2G-kADrHpkiYIeMEQl5gnUHy_pnZKadJ1Q/od6/public/values?alt=json-in-script&callback=importGSS"></script>

</body>
</html>

